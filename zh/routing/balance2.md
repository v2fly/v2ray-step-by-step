# 負載均衡 2

在前面的章節當中有提到過利用 V2Ray 的一個特性來實現負載均衡。但是由於這種負載均衡是投機取巧利用配置實現的，最終的效果不盡如人意，也就在特殊情況下用一用而已，也有人認爲這種輪詢的機制壓根算不上負載均衡。不過經過漫長的等待，V2Ray 終於可均衡負載了，但是可能 V2Ray 認爲時機還不成熟，官方文檔上並沒有負載均衡方面的描述。我研究了一番源代碼，粗略測試了幾分鐘，V2Ray v4.3 版本可以均衡負載了，於是放出本篇教程給大夥嚐嚐鮮。

## 配置

負載均衡的配置位於 routing 字段，僅需在客戶端上配置即可。在 routing 當中，配置一個 balancers 數組,代表這負載均衡的規則，每一個對象包含負載均衡唯一的標籤，均衡策略(目前的策略好像只有隨機選擇)以及可選擇的出站代理。然後在路由規則中根據需要配置特定的流量進行負載均衡。在本例中，最後一個路由規則爲負載均衡。根據示例可以知道目的地址是私有 IP 或中國大陸的流量直連，其餘的所有流量是負載均衡 b1(即 在 jp1 和 jp2 兩者之間選擇)。本例中沒有使用到 b2 的負載均衡。 

```json
{

  "inbounds": [
    ...
  ],
  "outbounds": [
    {
      "tag": "us1",
      ...
    },
    {
      "tag": "jp1",
      ...
    },
    {
      "tag": "jp2",
      ...
    },
    {
      "tag": "hk1",
      ...
    },
    {
      "tag": "direct",
      ...
    }
  ],
  "routing": {
    "domainStrategy": "IPOnDemand",
    "balancers": [
      {
        "tag": "b1",
        "selector": [
          "jp1",
          "jp2"
        ]
      },
      {
        "tag": "b2",
        "selector": [
          "us1",
          "hk1"
        ]
      }
    ],
    "rules": [
      {
        "type": "field",
        "outboundTag": "direct",
        "ip": [
          "geoip:private",
          "geoip:cn"
        ]
      },
      {
        "type": "field",
        "outboundTag": "direct",
        "domain": [
          "geosite:cn"
        ]
      },
      {
        "type": "field",
        "network": "tcp,udp",
        "balancerTag": "b1"
      }
    ]
  }
}
```

從配置中可以看出，V2Ray 的負載均衡同樣有着高度靈活的優點，可以針對指定的流量進行負載均衡，也可以按需配置多個負載均衡，不同底層傳輸配置的出站協議也可以負載均衡，可以說 V2Ray 的路由有多靈活那麼它的負載均衡就有多靈活。

可能是剛剛推出的原因，現在的均衡策略只有隨機選擇，隨着時間的推進應該會陸續有其他的策略。

#### 更新歷史

- 2018-11-09 初版
- 2019-11-01 修正某些情況下 IP 規則無法匹配
